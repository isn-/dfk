include_directories(${CMAKE_CURRENT_BINARY_DIR})
include_directories(${CMAKE_CURRENT_SOURCE_DIR})

set(ut_sources
  test_core.c
  test_list.c
  test_avltree.c
  test_tcp_socket.c)

set(ut_init_c "${CMAKE_CURRENT_BINARY_DIR}/ut_init.c")
set(ut_init_h "${CMAKE_CURRENT_BINARY_DIR}/ut_init.h")

add_executable(ut-dfk
  ${ut_sources}
  ${ut_init_h}
  ${ut_init_c}
  naivetp/naivetp.h
  naivetp/naivetp.c
  main.c)

target_link_libraries(ut-dfk dfk)

file(WRITE ${ut_init_h}
"/*
  * @copyright
  * Copyright (c) 2015, 2016, Stanislav Ivochkin. All Rights Reserved.
  *
  * @attention Generated by build system, do not edit
  */
#pragma once
\n")
file(WRITE ${ut_init_c}
"/*
  * @copyright
  * Copyright (c) 2015, 2016, Stanislav Ivochkin. All Rights Reserved.
  *
  * @attention Generated by build system, do not edit
  */
#include \"ut.h\"
#include \"ut_init.h\"

void ut_register_all_test_cases(void)
{\n")

foreach(source ${ut_sources})
  file(READ "${source}" contents)
  string(REGEX MATCHALL "((DISABLED_))?TEST((_F))?\\(([A-Za-z_0-9 ,]+)\\)" found_tests ${contents})
  foreach(hit ${found_tests})
    string(REGEX REPLACE ".*\\(( *[A-Za-z_0-9]+ *,)? *([A-Za-z_0-9]+), *([A-Za-z_0-9]+) *\\).*" "\\2" test_group ${hit})
    string(REGEX REPLACE ".*\\(( *[A-Za-z_0-9]+ *,)? *([A-Za-z_0-9]+), *([A-Za-z_0-9]+) *\\).*" "\\3" test_name ${hit})
    add_test(${test_group}.${test_name} "${CMAKE_RUNTIME_OUTPUT_DIRECTORY}/ut-dfk" ${test_group} ${test_name})
    file(APPEND ${ut_init_h} "extern void ut_${test_group}_${test_name}(void);\n")
    file(APPEND ${ut_init_c} "  ut_register_test_case(\"${test_group}\", \"${test_name}\", ut_${test_group}_${test_name});\n")
  endforeach()
endforeach()

file(APPEND ${ut_init_c} "}\n\n")
file(APPEND ${ut_init_h} "\n")

if(VALGRIND AND NOT DFK_ENABLE_COVERAGE)
  set(suppressions "${CMAKE_SOURCE_DIR}/scripts/pthread_create.supp")
  add_test(valgrind.all_tests ${VALGRIND} --error-exitcode=1 --leak-check=full --suppressions=${suppressions} "${CMAKE_RUNTIME_OUTPUT_DIRECTORY}/ut-dfk")
endif()
